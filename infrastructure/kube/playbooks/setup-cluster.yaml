---
- name: Setup control planes
  hosts: control_planes
  become: true
  tasks:
      - name: Check if cluster is already initialized
        ansible.builtin.stat:
            path: /etc/kubernetes/admin.conf
        register: cluster_initialized

      - name: Initialize control plane
        ansible.builtin.command: >
            kubeadm init
            --node-name {{ node_name }}
            --control-plane-endpoint={{ control_plane_endpoint }}:{{ control_plane_endpoint_port }}
            --pod-network-cidr={{ pod_cidr_range }}
            --service-cidr={{ cni_cidr_range }}
            --skip-phases=addon/kube-proxy
        when: inventory_hostname == groups['control_planes'][0] and not cluster_initialized.stat.exists
        changed_when: false

      - name: Generate join token
        ansible.builtin.command: kubeadm token create --print-join-command
        register: join_command
        when: inventory_hostname == groups['control_planes'][0]
        changed_when: false

      - name: Create .kube directory for user
        ansible.builtin.file:
            path: "/home/{{ ansible_user }}/.kube"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: "0755"
        when:
            - inventory_hostname == groups['control_planes'][0]

      - name: Copy kubeadm config to userfolder on remote
        ansible.builtin.copy:
            src: /etc/kubernetes/admin.conf
            dest: "/home/{{ ansible_user }}/.kube/config"
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: "0644"
            remote_src: true
        become: true
        when:
            - inventory_hostname == groups['control_planes'][0]

      - name: Copy kubeadm config to local user
        ansible.builtin.fetch:
            src: "/home/{{ ansible_user }}/.kube/config"
            dest: "{{ lookup('env', 'HOME') }}/.kube/config"
            flat: true
            mode: "0644"
            fail_on_missing: true
        become: false
        when:
            - inventory_hostname == groups['control_planes'][0]

- name: Join worker nodes
  hosts: worker_nodes
  become: true
  tasks:
      - name: Check if node is actually joined and ready in cluster
        ansible.builtin.command: kubectl get nodes -o jsonpath='{.items[*].metadata.name}'
        register: cluster_nodes
        failed_when: false
        changed_when: false
        delegate_to: "{{ groups['control_planes'][0] }}"
        environment:
            KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

      - name: Check if current node is in the cluster nodes list
        ansible.builtin.set_fact:
            node_in_cluster: "{{ (node_name in cluster_nodes.stdout.split()) if cluster_nodes.rc == 0 and cluster_nodes.stdout != '' else false }}"

      - name: Join worker nodes to cluster
        ansible.builtin.command: "{{ hostvars[groups['control_planes'][0]]['join_command']['stdout'] }} --node-name {{ node_name }}"
        when: not (node_in_cluster | default(false))
        changed_when: false
